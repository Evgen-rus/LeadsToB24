# LeadsToB24

Система для автоматизации обработки данных из Google Таблицы, записи в SQLite и маршрутизации лидов в соответствии с тегами.

## Назначение

Программа собирает данные о лидах из Google Таблицы, обрабатывает их, сохраняет в базу данных SQLite и маршрутизирует по клиентам в соответствии с тегами. Каждый клиент может получать данные в свою Google Таблицу и/или через вебхук в CRM.

## Общая схема работы

1. Система регулярно проверяет наличие новых строк в исходной Google Таблице
2. Новые строки обрабатываются, из них извлекаются данные (ID, телефон, тег проекта)
3. Данные сохраняются в локальную базу данных SQLite
4. На основе тега система определяет, какому клиенту принадлежит лид
5. Данные отправляются в таблицу клиента и/или через вебхук в CRM
6. Обработанные строки помечаются галочкой ✅ в исходной таблице

## Требования

- Python 3.8 или выше
- Pip для установки зависимостей
- Учетные данные сервисного аккаунта Google для доступа к API

## Зависимости

- `google-auth`
- `google-api-python-client`
- `requests`
- `python-dotenv`

## Установка

1. Клонировать репозиторий:

```bash
git clone https://github.com/yourusername/LeadsToB24.git
cd LeadsToB24
```

2. Установить зависимости:

```bash
pip install -r requirements.txt
```

3. Скопировать пример файла `.env` и настроить:

```bash
cp .env.example .env
```

4. Редактировать `.env` файл, указав необходимые параметры:

```bash
SOURCE_SPREADSHEET_ID=your_spreadsheet_id_here
SOURCE_SHEET_NAME=Февраль 2025
DB_PATH=database/leads.db
CHECK_INTERVAL=10
```

5. Поместить файл учетных данных сервисного аккаунта Google в директорию `credentials/` с именем `sheets-credentials.json`.

## Начальная настройка

1. Инициализировать базу данных:

```bash
python -m src.cli init-db
```

2. Проверьте, что сервисный аккаунт Google имеет доступ к нужным таблицам:
   - Исходная таблица (SOURCE_SPREADSHEET_ID)
   - Таблицы клиентов (для каждого клиента своя)

## Использование

### Добавление клиента

Для добавления нового клиента используйте команду:

```bash
python -m src.cli add-client --name "Имя клиента" --tag "Тег для маршрутизации" --sheet-id "ID таблицы" --sheet-name "Имя листа" [--use-crm] [--webhook-url "URL вебхука"]
```

Обязательные параметры:

- `--name`: Название клиента
- `--tag`: Тег для маршрутизации (например, "[ДМД13] Диалог Чанган Казань")

Необязательные параметры:

- `--sheet-id`: ID Google Таблицы клиента
- `--sheet-name`: Название листа в таблице клиента
- `--use-crm`: Флаг для включения отправки данных через вебхук в CRM
- `--webhook-url`: URL вебхука для отправки данных в CRM

Примеры:

1. Добавление клиента с отправкой только в Google Таблицу:

```bash
python -m src.cli add-client --name "Диалог Чанган Казань" --tag "[ДМД13] Диалог Чанган Казань" --sheet-id "1-274mVvqfIWU08M5sJ3IakfVh_wnunN8P6gh9MB1ru4" --sheet-name "Лиды"
```

2. Добавление клиента с отправкой через вебхук в CRM:

```bash
python -m src.cli add-client --name "Неометрия Ростов" --tag "[П8] Неометрия Ростов" --use-crm --webhook-url "https://example.com/webhook"
```

3. Добавление клиента с отправкой и в таблицу, и в CRM:

```bash
python -m src.cli add-client --name "МОЛОТОВ-1" --tag "[П179] МОЛОТОВ-1 проектирование" --sheet-id "your-spreadsheet-id" --sheet-name "Лиды" --use-crm --webhook-url "https://example.com/webhook"
```

### Проверка списка клиентов

Для просмотра списка всех добавленных клиентов:

```bash
python -m src.cli list-clients
```

Для вывода в формате JSON:

```bash
python -m src.cli list-clients --json
```

### Обработка данных вручную

Для ручного запуска обработки данных из исходной таблицы:

```bash
python -m src.cli process-data
```

С принудительной обработкой всех строк (даже отмеченных галочкой):

```bash
python -m src.cli process-data --force
```

С подробным выводом:

```bash
python -m src.cli process-data --verbose
```

### Запуск в режиме демона

Для запуска системы в режиме постоянной работы с периодической проверкой новых данных:

```bash
python -m src.cli run-daemon
```

С указанием интервала проверки (в секундах):

```bash
python -m src.cli run-daemon --interval 300  # Проверка каждые 5 минут
```

### Проверка статуса доставки

Для проверки статуса доставки данных клиентам:

```bash
python -m src.cli delivery-status
```

С фильтрацией по тегу:

```bash
python -m src.cli delivery-status --tag "[ДМД13] Диалог Чанган Казань"
```

С фильтрацией по дате:

```bash
python -m src.cli delivery-status --since "2025-04-01"
```

### Повторная отправка данных

Для повторной отправки данных, которые не были доставлены:

```bash
python -m src.cli retry-delivery
```

С ограничением по количеству попыток:

```bash
python -m src.cli retry-delivery --max-attempts 3
```

С фильтрацией по тегу:

```bash
python -m src.cli retry-delivery --tag "[ДМД13] Диалог Чанган Казань"
```

С указанием целевого направления (только таблицы, только CRM или оба):

```bash
python -m src.cli retry-delivery --target sheet  # Только таблицы
python -m src.cli retry-delivery --target crm    # Только CRM
python -m src.cli retry-delivery --target both   # И таблицы, и CRM (по умолчанию)
```

## Обработка тегов проектов

Система автоматически очищает теги проектов перед маршрутизацией:

1. Удаляется префикс вида "B1_", "B3_", "В2_" и т.д.
2. Удаляются лишние пробелы в начале и конце строки
3. Удаляется "хвост" после второго подчеркивания (если есть)

Примеры преобразования тегов:

- "B1_[ДМД13] Диалог Чанган Казань" -> "[ДМД13] Диалог Чанган Казань"
- "B3_[П8] Неометрия Ростов_new" -> "[П8] Неометрия Ростов_new"
- "[П179] МОЛОТОВ-1 проектирование" -> "[П179] МОЛОТОВ-1 проектирование"

**Важно:** При добавлении клиента указывайте тег в уже очищенном виде (как он будет выглядеть после обработки).

## Структура проекта

```
LeadsToB24/
├── src/
│   ├── main.py          # Главный входной скрипт
│   ├── setup.py         # Конфигурация и настройки
│   ├── db.py            # Модуль для работы с SQLite
│   ├── processor.py     # Обработка данных и тегов
│   ├── service.py       # Сервисные функции
│   ├── router.py        # Маршрутизация данных
│   ├── client_config.py # Управление конфигурацией клиентов
│   ├── client_sheets.py # Отправка данных в таблицы клиентов
│   ├── webhook.py       # Отправка данных через вебхуки
│   ├── scheduler.py     # Планировщик задач
│   ├── setup_db.py      # Скрипт для настройки БД
│   └── cli.py           # Интерфейс командной строки
├── credentials/         # Директория для хранения credentials.json
├── database/            # Директория для БД
├── logs/                # Директория для логов
├── .env                 # Переменные окружения
├── .env.example         # Пример файла .env
├── requirements.txt     # Зависимости проекта
└── README.md            # Документация проекта
```

## Частые проблемы и их решение

### 1. Данные не попадают в таблицу клиента

Возможные причины:

- Неправильно указан тег клиента
- Сервисный аккаунт Google не имеет доступа к таблице клиента
- Неправильно указаны ID таблицы или имя листа

Решение:

1. Проверьте настройки клиента:
   ```bash
   python -m src.cli list-clients
   ```
2. Убедитесь, что тег клиента соответствует тегу в исходной таблице (после очистки)
3. Проверьте доступ сервисного аккаунта к таблице клиента
4. Проверьте статус доставки:
   ```bash
   python -m src.cli delivery-status --tag "[Тег клиента]"
   ```

### 2. Ошибки аутентификации в Google Sheets API

Возможные причины:

- Неправильный файл учетных данных
- Истек срок действия ключа сервисного аккаунта
- Недостаточные права доступа

Решение:

1. Убедитесь, что файл `credentials/sheets-credentials.json` содержит правильные учетные данные
2. Обновите ключ сервисного аккаунта в консоли Google Cloud
3. Предоставьте сервисному аккаунту права доступа ко всем необходимым таблицам

### 3. Данные не отправляются через вебхук в CRM

Возможные причины:

- Неправильный URL вебхука
- Недоступность сервера CRM
- Неправильный формат данных

Решение:

1. Проверьте настройки вебхука:
   ```bash
   python -m src.cli list-clients
   ```
2. Проверьте статус доставки:
   ```bash
   python -m src.cli delivery-status --tag "[Тег клиента]"
   ```
3. Попробуйте повторно отправить данные:
   ```bash
   python -m src.cli retry-delivery --tag "[Тег клиента]" --target crm
   ```

## Рекомендации по безопасности

1. Храните файл учетных данных Google в безопасном месте и не публикуйте его
2. Не включайте файл с учетными данными в репозиторий
3. Используйте HTTPS для вебхуков
4. Регулярно обновляйте ключи сервисного аккаунта
5. Предоставляйте сервисному аккаунту минимально необходимые права

## Шаги по добавлению нового клиента - Пошаговая инструкция

1. **Подготовка таблицы клиента:**

   - Создайте новую таблицу в Google Sheets (или используйте существующую)
   - Создайте лист с названием (например, "Лиды")
   - Предоставьте доступ сервисному аккаунту (адрес из файла credentials.json, поле client_email)
   - Добавьте заголовки в первую строку (Дата отправки, Дата создания, ID, Телефон, Тег)
2. **Получение необходимой информации:**

   - ID таблицы (из URL: https://docs.google.com/spreadsheets/d/YOUR_SPREADSHEET_ID/edit)
   - Название листа
   - Тег для маршрутизации (в том формате, как он будет после очистки)
3. **Добавление клиента в систему:**

   ```bash
   python -m src.cli add-client --name "Имя клиента" --tag "Тег для маршрутизации" --sheet-id "ID таблицы" --sheet-name "Имя листа"
   ```
4. **Проверка добавления клиента:**

   ```bash
   python -m src.cli list-clients
   ```
5. **Тестирование маршрутизации:**

   - Добавьте тестовую запись в исходную таблицу с соответствующим тегом
   - Запустите обработку данных:
     ```bash
     python -m src.cli process-data --verbose
     ```
   - Проверьте, что данные появились в таблице клиента
   - Проверьте статус доставки:
     ```bash
     python -m src.cli delivery-status --tag "Тег для маршрутизации"
     ```
6. **Настройка автоматической обработки:**

   ```bash
   python -m src.cli run-daemon --interval 600  # Проверка каждые 10 минут
   ```

## Техническая поддержка

По вопросам работы с системой обращайтесь к администратору проекта.

## Запуск системы в фоновом режиме (Windows)

Для запуска системы в фоновом режиме в Windows можно использовать несколько подходов:

### 1. Использование PowerShell

```powershell
Start-Process -NoNewWindow python -ArgumentList "-m src.cli run-daemon --interval 600"
```

### 2. Использование pythonw.exe

```bash
pythonw -m src.cli run-daemon --interval 600
```

### 3. Создание службы Windows

Для создания постоянной службы Windows рекомендуется использовать NSSM (Non-Sucking Service Manager):

1. Скачайте NSSM с сайта: https://nssm.cc/download
2. Установите службу с помощью команды:

```bash
nssm install LeadsToB24Service "C:\Path\To\Python\python.exe" "-m src.cli run-daemon --interval 600"
nssm set LeadsToB24Service AppDirectory "C:\Path\To\LeadsToB24"
nssm start LeadsToB24Service
```

### 4. Создание BAT-файла для автозапуска

Создайте файл `start_service.bat` со следующим содержимым:

```batch
@echo off
cd /d %~dp0
start /min cmd /c "python -m src.cli run-daemon --interval 600"
```

Затем создайте ярлык на этот файл и поместите его в папку автозагрузки:
`C:\Users\%USERNAME%\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup`
